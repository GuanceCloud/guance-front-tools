{"title":"荷丹路kubernetes 监控大屏 新","dashboardExtend":{"groupUnfoldStatus":{}},"main":{"vars":[],"charts":[{"extend":{"settings":{"showTopSize":true,"chartType":"bar"}},"group":{"name":null},"pos":{"x":0,"y":0.5,"h":9.6,"w":6},"name":"核心组件可用率","queries":[{"datasource":"dataflux","qtype":"promql","type":"toplist","query":{"q":"avg(node:node_cpu_load_rate{instance=~\"hd-l-base-k8sno.+\"})","type":"promql"}},{"datasource":"dataflux","qtype":"promql","type":"toplist","query":{"q":"avg(node:node_memory_usage_rate{instance=~\"hd-l-base-k8sno.+\"})","type":"promql"}},{"datasource":"dataflux","qtype":"promql","type":"toplist","query":{"q":"kube_deployment_status_replicas_available{datacenter=\"hd\", deployment=~\"coredns\"} / kube_deployment_spec_replicas{datacenter=\"hd\", deployment=~\"coredns\"} ","type":"promql"}},{"datasource":"dataflux","qtype":"promql","type":"toplist","query":{"q":"kube_daemonset_status_number_available{datacenter=\"hd\", daemonset=\"calico-node\"} / kube_daemonset_status_desired_number_scheduled{datacenter=\"hd\", daemonset=\"calico-node\"}","type":"promql"}},{"datasource":"dataflux","qtype":"promql","type":"toplist","query":{"q":"sum(up{job=~\"apiserver|kube-controller-manager|kube-scheduler|etcd-k8s\"}) by (job) / 3","type":"promql"}}],"type":"toplist"},{"extend":{"settings":{}},"group":{"name":null},"pos":{"x":6,"y":0.5,"h":9.6,"w":3},"name":"Etcd 选举次数","queries":[{"datasource":"dataflux","qtype":"promql","type":"singlestat","query":{"q":"sum(changes(etcd_server_leader_changes_seen_total{job=\"etcd-k8s\"}[5m]))","type":"promql"}}],"type":"singlestat"},{"extend":{"settings":{}},"group":{"name":null},"pos":{"x":9,"y":0.5,"h":9.6,"w":3},"name":"Ingress Nginx 总请求次数","queries":[{"datasource":"dataflux","qtype":"promql","type":"singlestat","query":{"q":"sum(irate(nginx_ingress_controller_nginx_process_requests_total{controller_pod=~\"nginx-ingress-controller.+\"}[5m]))","type":"promql"}}],"type":"singlestat"},{"extend":{"settings":{}},"group":{"name":null},"pos":{"x":12,"y":0.5,"h":9.6,"w":3},"name":"Istio Ingressgateway 总请求次数","queries":[{"datasource":"dataflux","qtype":"promql","type":"singlestat","query":{"q":"sum(irate(istio_requests_total[5m]))","type":"promql"}}],"type":"singlestat"},{"extend":{"settings":{}},"group":{"name":null},"pos":{"x":15,"y":0.5,"h":9.6,"w":4},"name":"k8s组件日志情况","queries":[{"datasource":"dataflux","qtype":"promql","type":"sequence","query":{"q":"((((appname:k8s AND NOT json.level:I) AND NOT json.ip:10.200.8.91) AND NOT json.ip:10.200.8.102) AND NOT json.ip:10.200.8.93) AND NOT 'json.ip':10.200.8.92|timechart span=1m count() by json.level|rename 'count():E' as error  'count():W' as warning","type":"promql"}}],"type":"sequence"},{"extend":{"settings":{}},"group":{"name":null},"pos":{"x":19,"y":0.5,"h":9.6,"w":5},"name":"Ingress Nginx 错误日志情况","queries":[{"datasource":"dataflux","qtype":"promql","type":"sequence","query":{"q":"appname:ingress_err AND NOT 'json.level':warn AND NOT preview AND NOT haoportal.huazhu.com AND NOT \"could not parse backends data\"| timechart span=1m count() by json.level |rename 'count():error' as error 'count():warn' as warning 'count():crit' as critial 'count():notice' as notice","type":"promql"}}],"type":"sequence"},{"extend":{"settings":{}},"group":{"name":null},"pos":{"x":0,"y":9.6,"h":9.6,"w":12},"name":"Ingress Nginx Cpu核数","queries":[{"datasource":"dataflux","qtype":"promql","type":"sequence","query":{"q":"avg(irate(container_cpu_usage_seconds_total{container=\"nginx-ingress-controller\"}[5m])) by (pod)","type":"promql"}}],"type":"sequence"},{"extend":{"settings":{}},"group":{"name":null},"pos":{"x":12,"y":9.6,"h":9.6,"w":6},"name":"Ingress Nginx 集群连接状态","queries":[{"datasource":"dataflux","qtype":"promql","type":"sequence","query":{"q":"sum(nginx_ingress_controller_nginx_process_connections{controller_pod=~\"nginx-ingress-controller-all-.+\"}) by (state)","type":"promql"}},{"datasource":"dataflux","qtype":"promql","type":"sequence","query":{"q":"sum(nginx_ingress_controller_nginx_process_connections{controller_pod=~\"nginx-ingress-controller-base-.+\"}) by (state)","type":"promql"}}],"type":"sequence"},{"extend":{"settings":{}},"group":{"name":null},"pos":{"x":18,"y":9.6,"h":9.6,"w":6},"name":"Ingress Nginx 4xx/5xx 请求","queries":[{"datasource":"dataflux","qtype":"promql","type":"sequence","query":{"q":"sum(increase(nginx_ingress_controller_requests{status=~\"[4-5].+\"}[1m])) by (status) > 0","type":"promql"}}],"type":"sequence"},{"extend":{"settings":{}},"group":{"name":null},"pos":{"x":0,"y":19.1,"h":13.4,"w":8},"name":"k8s节点 load 与 cpu核心数 比率","queries":[{"datasource":"dataflux","qtype":"promql","type":"sequence","query":{"q":"node:node_cpu_load_rate{instance=~\".*k8s.*\"}","type":"promql"}}],"type":"sequence"},{"extend":{"settings":{}},"group":{"name":null},"pos":{"x":8,"y":19.1,"h":13.4,"w":8},"name":"k8s 节点内存使用率","queries":[{"datasource":"dataflux","qtype":"promql","type":"sequence","query":{"q":"node:node_memory_usage_rate{datacenter!=\"jq\",instance=~\".+k8s.+\"}","type":"promql"}}],"type":"sequence"},{"extend":{"settings":{}},"group":{"name":null},"pos":{"x":16,"y":19.1,"h":7.7,"w":4},"name":"node节点剩余内存","queries":[{"datasource":"dataflux","qtype":"promql","type":"singlestat","query":{"q":"sum(node_memory_MemAvailable_bytes{instance=~\"hd-l-base-k8sno.*\"})\r","type":"promql"}}],"type":"singlestat"},{"extend":{"settings":{}},"group":{"name":null},"pos":{"x":20,"y":19.1,"h":7.7,"w":4},"name":"node节点剩余cpu（逻辑核）","queries":[{"datasource":"dataflux","qtype":"promql","type":"singlestat","query":{"q":"count(node_softnet_dropped_total{instance=~\"hd-l-base-k8sno.*\"}) * avg(sum(rate(node_cpu_seconds_total{mode=\"idle\",instance=~\"hd-l-base-k8sno.*\"}[1m])) by (instance)) /100\r\n","type":"promql"}}],"type":"singlestat"},{"extend":{"settings":{}},"group":{"name":null},"pos":{"x":16,"y":26.7,"h":5.8,"w":4},"name":"CoreDNS QPS","queries":[{"datasource":"dataflux","qtype":"promql","type":"singlestat","query":{"q":"sum(irate(coredns_dns_request_count_total{service=\"kube-dns\"}[5m]))","type":"promql"}}],"type":"singlestat"},{"extend":{"settings":{}},"group":{"name":null},"pos":{"x":20,"y":26.7,"h":11.5,"w":4},"name":"Zombie Processes","queries":[{"datasource":"dataflux","qtype":"promql","type":"sequence","query":{"q":"sum(node_processes_state{state=\"Z\", instance=~\".+k8s.+\"}) by (instance)","type":"promql"}}],"type":"sequence"},{"extend":{"settings":{}},"group":{"name":null},"pos":{"x":0,"y":32.4,"h":13.4,"w":8},"name":"k8s节点 磁盘使用率","queries":[{"datasource":"dataflux","qtype":"promql","type":"sequence","query":{"q":"node:node_disk_filesystem_usage_rate{mountpoint=\"/data\"}","type":"promql"}},{"datasource":"dataflux","qtype":"promql","type":"sequence","query":{"q":"node:node_disk_filesystem_usage_rate{mountpoint!=\"/data\"} > 0.7","type":"promql"}},{"datasource":"dataflux","qtype":"promql","type":"sequence","query":{"q":"node:node_disk_filesystem_usage_rate{mountpoint=\"/\"}","type":"promql"}}],"type":"sequence"},{"extend":{"settings":{}},"group":{"name":null},"pos":{"x":8,"y":32.4,"h":13.4,"w":8},"name":"k8s节点 网络流量","queries":[{"datasource":"dataflux","qtype":"promql","type":"sequence","query":{"q":"0 - irate(node_network_transmit_bytes_total{device=~\"team.*\", instance=~\"hd-l-base-k8sno.+\"}[5m])","type":"promql"}},{"datasource":"dataflux","qtype":"promql","type":"sequence","query":{"q":"irate(node_network_receive_bytes_total{device=~\"team.*\", instance=~\"hd-l-base-k8sno.+\"}[5m])","type":"promql"}}],"type":"sequence"},{"extend":{"settings":{}},"group":{"name":null},"pos":{"x":16,"y":32.4,"h":5.8,"w":4},"name":"Network Error","queries":[{"datasource":"dataflux","qtype":"promql","type":"singlestat","query":{"q":"sum(irate(node_network_receive_errs_total{device=\"team0\"}[5m]) > 0)","type":"promql"}},{"datasource":"dataflux","qtype":"promql","type":"singlestat","query":{"q":"sum(irate(node_network_transmit_errs_total{device=\"team0\"}[5m]) > 0)","type":"promql"}}],"type":"singlestat"},{"extend":{"settings":{}},"group":{"name":null},"pos":{"x":16,"y":38.1,"h":7.7,"w":4},"name":"Felix error log","queries":[{"datasource":"dataflux","qtype":"promql","type":"singlestat","query":{"q":"sum(increase(felix_log_errors[5m]))","type":"promql"}}],"type":"singlestat"},{"extend":{"settings":{}},"group":{"name":null},"pos":{"x":0,"y":45.7,"h":11.5,"w":8},"name":"cpu 频率情况","queries":[{"datasource":"dataflux","qtype":"promql","type":"sequence","query":{"q":"avg(node_cpu_scaling_frequency_hertz{instance=~\"hd-l-base-k8s.*\"}) by (instance) ","type":"promql"}}],"type":"sequence"},{"extend":{"settings":{}},"group":{"name":null},"pos":{"x":8,"y":45.7,"h":11.5,"w":8},"name":"Node TCP State","queries":[{"datasource":"dataflux","qtype":"promql","type":"sequence","query":{"q":"node_tcp_connection_states{state!~\"(tx_queued_bytes|rx_queued_bytes|listen)\", instance=~\"hd-l.+\"}","type":"promql"}}],"type":"sequence"},{"extend":{"settings":{}},"group":{"name":null},"pos":{"x":16,"y":45.7,"h":11.5,"w":8},"name":"Node Process Pid Usage","queries":[{"datasource":"dataflux","qtype":"promql","type":"sequence","query":{"q":"node_processes_threads{instance=~\".+k8s.+\"} / node_processes_max_processes{instance=~\".+k8s.+\"}","type":"promql"}}],"type":"sequence"},{"extend":{"settings":{}},"group":{"name":null},"pos":{"x":0,"y":57.1,"h":15.3,"w":12},"name":"Ingress Nginx 4xx/5xx 请求","queries":[{"datasource":"dataflux","qtype":"promql","type":"sequence","query":{"q":"sum(increase(nginx_ingress_controller_requests{status=~\"499\"}[1m])) by (service, status) > 0","type":"promql"}}],"type":"sequence"},{"extend":{"settings":{}},"group":{"name":null},"pos":{"x":12,"y":57.1,"h":15.3,"w":12},"name":"cpu 温度","queries":[],"type":"sequence"},{"extend":{"settings":{}},"group":{"name":null},"pos":{"x":0,"y":72.3,"h":15.3,"w":12},"name":"调用源 程序cpu","queries":[{"datasource":"dataflux","qtype":"promql","type":"sequence","query":{"q":"avg(irate(container_cpu_usage_seconds_total{container!=\"(POD|istio-proxy)\", namespace=\"sre\", pod=~\"invokesource.+\"}[5m]) ) by (pod)\r\n/\r\nmax( kube_pod_container_resource_limits_cpu_cores{namespace=\"sre\", pod=~\"invokesource.+\"} ) by (pod)","type":"promql"}}],"type":"sequence"},{"extend":{"settings":{}},"group":{"name":null},"pos":{"x":12,"y":72.3,"h":15.3,"w":12},"name":"调用源 程序内存","queries":[{"datasource":"dataflux","qtype":"promql","type":"sequence","query":{"q":"avg(container_memory_working_set_bytes{ container!=\"POD\",namespace=\"sre\", pod=~\"invokesource.+\"} ) by (pod)\r\n/\r\nmax( kube_pod_container_resource_limits_memory_bytes{namespace=\"sre\", pod=~\"invokesource.+\"} ) by (pod)","type":"promql"}}],"type":"sequence"},{"extend":{"settings":{}},"group":{"name":null},"pos":{"x":0,"y":87.5,"h":15.3,"w":12},"name":"Certficate Status","queries":[{"datasource":"dataflux","qtype":"promql","type":"sequence","query":{"q":"count(kube_certificatesigningrequest_condition)","type":"promql"}}],"type":"sequence"},{"extend":{"settings":{}},"group":{"name":null},"pos":{"x":12,"y":87.5,"h":15.3,"w":12},"name":"cpu 使用量","queries":[{"datasource":"dataflux","qtype":"promql","type":"sequence","query":{"q":"avg(rate(container_cpu_usage_seconds_total{namespace!~\"(netis|sre)\", container!~\"(POD|istio-proxy|olp-srvr-v1)\",service=\"kubelet\"}[5m]) ) by (container, namespace)\r\n        /\r\navg( kube_pod_container_resource_limits_cpu_cores ) by (container, namespace) * 100 > 50","type":"promql"}}],"type":"sequence"},{"extend":{"settings":{}},"group":{"name":null},"pos":{"x":0,"y":102.7,"h":11.5,"w":8},"name":"Node 重传","queries":[{"datasource":"dataflux","qtype":"promql","type":"sequence","query":{"q":"irate(node_netstat_Tcp_RetransSegs{instance=~\"hd-l.+\"}[1m])\r","type":"promql"}}],"type":"sequence"},{"extend":{"settings":{}},"group":{"name":null},"pos":{"x":8,"y":102.7,"h":11.5,"w":8},"name":"apiserver响应时间","queries":[{"datasource":"dataflux","qtype":"promql","type":"sequence","query":{"q":"histogram_quantile(0.95, sum(rate(apiserver_request_duration_seconds_bucket{verb!~\"CONNECT|WATCH\",instance=~\"10.200.24.*\"}[5m])) by (le,instance))","type":"promql"}}],"type":"sequence"}],"groups":[]}}